<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bank</a> &gt; <a href="index.source.html" class="el_package">com.telran.bank.service.impl</a> &gt; <span class="el_source">TransactionServiceImpl.java</span></div><h1>TransactionServiceImpl.java</h1><pre class="source lang-java linenums">package com.telran.bank.service.impl;

import com.telran.bank.dto.TransactionDTO;
import com.telran.bank.entity.Transaction;
import com.telran.bank.entity.enums.TransactionType;
import com.telran.bank.exception.TransactionNotFoundException;
import com.telran.bank.mapper.TransactionMapper;
import com.telran.bank.repository.TransactionRepository;
import com.telran.bank.service.TransactionService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Objects;

import static com.telran.bank.entity.enums.TransactionType.*;
import static com.telran.bank.service.util.RequestChecker.checkDate;
import static com.telran.bank.service.util.RequestChecker.checkTransactionType;

@Service
<span class="fc" id="L23">@RequiredArgsConstructor</span>
public class TransactionServiceImpl implements TransactionService {

    private final TransactionRepository transactionRepository;

<span class="fc" id="L28">    private final DateTimeFormatter format = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span>

    private final TransactionMapper transactionMapper;

    protected Transaction createTransaction(String fromId, String toId, Double amount) {
<span class="pc bpc" id="L33" title="1 of 2 branches missed.">        if (Objects.equals(fromId, toId)) {</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">            if (amount &lt; 0) {</span>
<span class="nc" id="L35">                return saveTransaction(new Transaction(ATM_WITHDRAW, fromId, toId, amount));</span>
            } else {
<span class="fc" id="L37">                return saveTransaction(new Transaction(ATM_DEPOSIT, fromId, toId, amount));</span>
            }
        } else {
<span class="nc" id="L40">            return saveTransaction(new Transaction(MONEY_TRANSFER, fromId, toId, amount));</span>
        }
    }

    private Transaction saveTransaction(Transaction transaction) {
<span class="fc" id="L45">        return transactionRepository.save(transaction);</span>
    }

    @Override
    public TransactionDTO getTransaction(Long id) {
<span class="fc" id="L50">        return transactionMapper.toDTO(transactionRepository.findById(id)</span>
<span class="fc" id="L51">                .orElseThrow(() -&gt; new TransactionNotFoundException(&quot;id = &quot; + id)));</span>
    }

    @Override
    public List&lt;TransactionDTO&gt; getAllTransactions(String date, String type, String sort) {
<span class="fc" id="L56">        checkTransactionType(type);</span>
<span class="fc" id="L57">        checkDate(date);</span>
<span class="fc" id="L58">        return transactionMapper.transactionsToTransactionDTOs(getTransactionsWithParameters(date, type, sort));</span>
    }

    private List&lt;Transaction&gt; getTransactionsWithParameters(String date, String type, String sort) {
<span class="pc bpc" id="L62" title="2 of 4 branches missed.">        boolean dateIsNotNullOrEmpty = date != null &amp;&amp; !date.isBlank();</span>
<span class="pc bpc" id="L63" title="2 of 4 branches missed.">        boolean typeIsNotNullOrEmpty = type != null &amp;&amp; !type.isEmpty();</span>
<span class="pc bpc" id="L64" title="2 of 4 branches missed.">        boolean dateAndTypeAreNotNullOrEmpty = typeIsNotNullOrEmpty &amp;&amp; dateIsNotNullOrEmpty;</span>

<span class="pc bpc" id="L66" title="2 of 4 branches missed.">        if (sort != null &amp;&amp; !sort.isBlank()) {</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">            if (sort.equalsIgnoreCase(&quot;dateTime&quot;)) {</span>
<span class="nc" id="L68">                return returnTransactionsOrderedByDateAsc(type, date, dateIsNotNullOrEmpty, typeIsNotNullOrEmpty, dateAndTypeAreNotNullOrEmpty);</span>

<span class="pc bpc" id="L70" title="1 of 2 branches missed.">            } else if (sort.equalsIgnoreCase(&quot;-dateTime&quot;)) {</span>
<span class="fc" id="L71">                return returnTransactionsOrderedByDateDesc(type, date, dateIsNotNullOrEmpty, typeIsNotNullOrEmpty, dateAndTypeAreNotNullOrEmpty);</span>

            } else
<span class="nc" id="L74">                return returnTransactionsWithoutOrder(type, date, dateIsNotNullOrEmpty, typeIsNotNullOrEmpty, dateAndTypeAreNotNullOrEmpty);</span>

        } else
<span class="nc" id="L77">            return returnTransactionsWithoutOrder(type, date, dateIsNotNullOrEmpty, typeIsNotNullOrEmpty, dateAndTypeAreNotNullOrEmpty);</span>
    }

    private List&lt;Transaction&gt; returnTransactionsWithoutOrder(String type,
                                                             String date,
                                                             boolean dateIsNotNullOrEmpty,
                                                             boolean typeIsNotNullOrEmpty,
                                                             boolean dateAndTypeAreNotNullOrEmpty) {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (dateAndTypeAreNotNullOrEmpty) {</span>
            //return all transactions with given TYPE and DATE
<span class="nc" id="L87">            return transactionRepository.findByTypeAndCreationDate(TransactionType.valueOf(type), LocalDate.parse(date, format));</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">        } else if (typeIsNotNullOrEmpty) {</span>
            //return all transactions with given TYPE
<span class="nc" id="L91">            return transactionRepository.findByType(TransactionType.valueOf(type));</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all transactions with given DATE
<span class="nc" id="L95">            return transactionRepository.findByCreationDate(LocalDate.parse(date, format));</span>

            //return all transactions
<span class="nc" id="L98">        } else return transactionRepository.findAll();</span>
    }

    private List&lt;Transaction&gt; returnTransactionsOrderedByDateDesc(String type,
                                                                  String date,
                                                                  boolean dateIsNotNullOrEmpty,
                                                                  boolean typeIsNotNullOrEmpty,
                                                                  boolean dateAndTypeAreNotNullOrEmpty) {
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (dateAndTypeAreNotNullOrEmpty) {</span>
            //return all transactions with given TYPE and DATE ordered DESCENDING by DATE
<span class="fc" id="L108">            return transactionRepository.findByTypeAndCreationDateOrderByCreationDateDesc(TransactionType.valueOf(type), LocalDate.parse(date, format));</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        } else if (typeIsNotNullOrEmpty) {</span>
            //return all transactions with given TYPE ordered DESCENDING by DATE
<span class="nc" id="L112">            return transactionRepository.findByTypeOrderByCreationDateDesc(TransactionType.valueOf(type));</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all transactions with given DATE ordered DESCENDING by DATE
<span class="nc" id="L116">            return transactionRepository.findByCreationDateOrderByCreationDateDesc(LocalDate.parse(date, format));</span>

            //return all transactions ordered DESCENDING by DATE
<span class="nc" id="L119">        } else return transactionRepository.findAllOrderedDesc();</span>
    }

    private List&lt;Transaction&gt; returnTransactionsOrderedByDateAsc(String type,
                                                                 String date,
                                                                 boolean dateIsNotNullOrEmpty,
                                                                 boolean typeIsNotNullOrEmpty,
                                                                 boolean dateAndTypeAreNotNullOrEmpty) {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (dateAndTypeAreNotNullOrEmpty) {</span>
            //return all transactions with given TYPE and DATE ordered ASCENDING by DATE
<span class="nc" id="L129">            return transactionRepository.findByTypeAndCreationDateOrderByCreationDateAsc(TransactionType.valueOf(type), LocalDate.parse(date, format));</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">        } else if (typeIsNotNullOrEmpty) {</span>
            //return all transactions with given TYPE ordered ASCENDING by DATE
<span class="nc" id="L133">            return transactionRepository.findByTypeOrderByCreationDateAsc(TransactionType.valueOf(type));</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all transactions with given DATE ordered ASCENDING by DATE
<span class="nc" id="L137">            return transactionRepository.findByCreationDateOrderByCreationDateAsc(LocalDate.parse(date, format));</span>

            //return all transactions ordered ASCENDING by DATE
<span class="nc" id="L140">        } else return transactionRepository.findAllOrderedAsc();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>