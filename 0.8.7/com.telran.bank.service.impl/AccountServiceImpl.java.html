<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bank</a> &gt; <a href="index.source.html" class="el_package">com.telran.bank.service.impl</a> &gt; <span class="el_source">AccountServiceImpl.java</span></div><h1>AccountServiceImpl.java</h1><pre class="source lang-java linenums">package com.telran.bank.service.impl;

import com.telran.bank.dto.AccountRequestDTO;
import com.telran.bank.dto.AccountResponseDTO;
import com.telran.bank.entity.Account;
import com.telran.bank.entity.Transaction;
import com.telran.bank.mapper.AccountMapper;
import com.telran.bank.repository.AccountRepository;
import com.telran.bank.service.AccountService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;

import static com.telran.bank.service.util.RequestChecker.*;
import static java.time.LocalDate.parse;

@Service
<span class="fc" id="L21">@RequiredArgsConstructor</span>
public class AccountServiceImpl implements AccountService {

    private final AccountMapper accountMapper;

    private final AccountRepository accountRepository;

    private final TransactionServiceImpl transactionServiceImpl;

    @Override
    @Transactional
    public AccountResponseDTO saveAccount(AccountRequestDTO accountRequestDTO) {
<span class="fc" id="L33">        return accountMapper.toResponseDTO(accountRepository.save(accountMapper.toEntity(accountRequestDTO)));</span>
    }

    @Override
    @Transactional
    public AccountResponseDTO editAccount(String id, AccountRequestDTO account) {
<span class="fc" id="L39">        Account patchedAccount = accountRepository.findById(id);</span>
<span class="fc" id="L40">        checkAccount(patchedAccount, id);</span>

<span class="pc bpc" id="L42" title="2 of 4 branches missed.">        if (account.getCity() != null &amp;&amp; !account.getCity().isEmpty())</span>
<span class="fc" id="L43">            patchedAccount.setCity(account.getCity());</span>

<span class="pc bpc" id="L45" title="2 of 4 branches missed.">        if (account.getCountry() != null &amp;&amp; !account.getCountry().isEmpty())</span>
<span class="fc" id="L46">            patchedAccount.setCountry(account.getCountry());</span>

<span class="pc bpc" id="L48" title="1 of 4 branches missed.">        if (account.getEmail() != null &amp;&amp; !account.getEmail().isEmpty())</span>
<span class="fc" id="L49">            patchedAccount.setEmail(account.getEmail());</span>

<span class="pc bpc" id="L51" title="1 of 4 branches missed.">        if (account.getFirstName() != null &amp;&amp; !account.getFirstName().isEmpty())</span>
<span class="fc" id="L52">            patchedAccount.setFirstName(account.getFirstName());</span>

<span class="pc bpc" id="L54" title="1 of 4 branches missed.">        if (account.getLastName() != null &amp;&amp; !account.getLastName().isEmpty())</span>
<span class="fc" id="L55">            patchedAccount.setLastName(account.getLastName());</span>

<span class="fc" id="L57">        accountRepository.updateAccountById(</span>
<span class="fc" id="L58">                patchedAccount.getEmail(),</span>
<span class="fc" id="L59">                patchedAccount.getFirstName(),</span>
<span class="fc" id="L60">                patchedAccount.getLastName(),</span>
<span class="fc" id="L61">                patchedAccount.getCountry(),</span>
<span class="fc" id="L62">                patchedAccount.getCity(),</span>
                id
        );

<span class="fc" id="L66">        return getAccount(id);</span>
    }

    @Override
    public AccountResponseDTO getAccount(String id) {
<span class="fc" id="L71">        Account account = accountRepository.findById(id);</span>
<span class="fc" id="L72">        checkAccount(account, id);</span>

<span class="fc" id="L74">        return accountMapper.toResponseDTO(account);</span>
    }

    @Override
    public List&lt;AccountResponseDTO&gt; getAllAccounts(String date, List&lt;String&gt; cities, String sort) {
<span class="fc" id="L79">        checkDate(date);</span>
<span class="fc" id="L80">        return accountMapper.accountsToAccountResponseDTOs(getAccountsWithParameters(date, cities, sort));</span>
    }

    @Override
    @Transactional
    public void putTransaction(String fromId,
                               String toId,
                               Double amount) {
<span class="nc" id="L88">        Account fromAccount = accountRepository.findById(fromId);</span>
<span class="nc" id="L89">        Account toAccount = accountRepository.findById(toId);</span>
<span class="nc" id="L90">        checkTransactionPossibility(fromId, toId, amount, fromAccount, toAccount);</span>

<span class="nc" id="L92">        Transaction transaction = transactionServiceImpl.createTransaction(fromId, toId, amount);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!fromId.equals(toId)) {</span>
<span class="nc" id="L95">            fromAccount.addTransaction(transaction);</span>
<span class="nc" id="L96">            fromAccount.setAmountOfMoney(fromAccount.getAmountOfMoney().add(BigDecimal.valueOf(-amount)));</span>
<span class="nc" id="L97">            accountRepository.updateAmountOfMoneyById(fromAccount.getAmountOfMoney(), fromId);</span>
        }

<span class="nc" id="L100">        toAccount.addTransaction(transaction);</span>
<span class="nc" id="L101">        toAccount.setAmountOfMoney(toAccount.getAmountOfMoney().add(BigDecimal.valueOf(amount)));</span>
<span class="nc" id="L102">        accountRepository.updateAmountOfMoneyById(toAccount.getAmountOfMoney(), toId);</span>
<span class="nc" id="L103">    }</span>

    private List&lt;Account&gt; getAccountsWithParameters(String date, List&lt;String&gt; cities, String sort) {
<span class="pc bpc" id="L106" title="2 of 4 branches missed.">        boolean dateIsNotNullOrEmpty = date != null &amp;&amp; !date.isBlank();</span>
<span class="pc bpc" id="L107" title="2 of 4 branches missed.">        boolean cityIsNotNullOrEmpty = cities != null &amp;&amp; !cities.isEmpty();</span>
<span class="pc bpc" id="L108" title="2 of 4 branches missed.">        boolean dateAndCityAreNotNullOrEmpty = dateIsNotNullOrEmpty &amp;&amp; cityIsNotNullOrEmpty;</span>

<span class="pc bpc" id="L110" title="2 of 4 branches missed.">        if (sort != null &amp;&amp; !sort.isBlank()) {</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (sort.equalsIgnoreCase(&quot;creationDate&quot;)) {</span>
<span class="nc" id="L112">                return returnAccountsOrderedByDateAsc(date, cities, dateIsNotNullOrEmpty, cityIsNotNullOrEmpty, dateAndCityAreNotNullOrEmpty);</span>

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">            } else if (sort.equalsIgnoreCase(&quot;-creationDate&quot;)) {</span>
<span class="fc" id="L115">                return returnAccountsOrderedByDateDesc(date, cities, dateIsNotNullOrEmpty, cityIsNotNullOrEmpty, dateAndCityAreNotNullOrEmpty);</span>

            } else
<span class="nc" id="L118">                return returnAccountsWithoutOrder(date, cities, dateIsNotNullOrEmpty, cityIsNotNullOrEmpty, dateAndCityAreNotNullOrEmpty);</span>

        } else
<span class="nc" id="L121">            return returnAccountsWithoutOrder(date, cities, dateIsNotNullOrEmpty, cityIsNotNullOrEmpty, dateAndCityAreNotNullOrEmpty);</span>
    }

    private List&lt;Account&gt; returnAccountsWithoutOrder(String date,
                                                     List&lt;String&gt; cities,
                                                     boolean dateIsNotNullOrEmpty,
                                                     boolean cityIsNotNullOrEmpty,
                                                     boolean dateAndCityAreNotNullOrEmpty) {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (dateAndCityAreNotNullOrEmpty) {</span>
            //return all accounts with given CITY and DATE
<span class="nc" id="L131">            return accountRepository.findByCityInAndCreationDate(cities, parse(date));</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        } else if (cityIsNotNullOrEmpty) {</span>
            //return all accounts with given CITY
<span class="nc" id="L134">            return accountRepository.findByCityIn(cities);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all accounts with given DATE
<span class="nc" id="L137">            return accountRepository.findByCreationDate(parse(date));</span>
        } else
            //return all accounts
<span class="nc" id="L140">            return accountRepository.findAll();</span>
    }

    private List&lt;Account&gt; returnAccountsOrderedByDateDesc(String date,
                                                          List&lt;String&gt; cities,
                                                          boolean dateIsNotNullOrEmpty,
                                                          boolean cityIsNotNullOrEmpty,
                                                          boolean dateAndCityAreNotNullOrEmpty) {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (dateAndCityAreNotNullOrEmpty) {</span>
            //return all accounts with given CITY and DATE ordered DESCENDING by DATE
<span class="fc" id="L150">            return accountRepository.findByCityInAndCreationDateOrderByCreationDateDesc(cities, parse(date));</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        } else if (cityIsNotNullOrEmpty) {</span>
            //return all accounts with given CITY ordered DESCENDING by DATE
<span class="nc" id="L153">            return accountRepository.findByCityInOrderByCreationDateDesc(cities);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all accounts with given DATE ordered DESCENDING by DATE
<span class="nc" id="L156">            return accountRepository.findByCreationDateOrderByCreationDateDesc(parse(date));</span>
            //return all accounts ordered DESCENDING by DATE
<span class="nc" id="L158">        } else return accountRepository.findAllOrderedDesc();</span>
    }

    private List&lt;Account&gt; returnAccountsOrderedByDateAsc(String date,
                                                         List&lt;String&gt; cities,
                                                         boolean dateIsNotNullOrEmpty,
                                                         boolean cityIsNotNullOrEmpty,
                                                         boolean dateAndCityAreNotNullOrEmpty) {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (dateAndCityAreNotNullOrEmpty) {</span>
            //return all accounts with given CITY and DATE ordered ASCENDING by DATE
<span class="nc" id="L168">            return accountRepository.findByCityInAndCreationDateOrderByCreationDateAsc(cities, parse(date));</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (cityIsNotNullOrEmpty) {</span>
            //return all accounts with given CITY ordered ASCENDING by DATE
<span class="nc" id="L171">            return accountRepository.findByCityInOrderByCreationDateAsc(cities);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        } else if (dateIsNotNullOrEmpty) {</span>
            //return all accounts with given DATE ordered ASCENDING by DATE
<span class="nc" id="L174">            return accountRepository.findByCreationDateOrderByCreationDateAsc(parse(date));</span>
            //return all accounts ordered ASCENDING by DATE
<span class="nc" id="L176">        } else return accountRepository.findAllOrderedAsc();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>